---
type: gap
knit: rqti::render_qtijs
---

# todos
- make two dfs, one is filtered for the ribbon regions
- add version where criterion is on the left (negative es_t), change alpha, es_t and labels
- better cover stories
- maybe use d on the x-axis? but in g-power it is also t, right?

# question

```{r, echo=F, warning=F, message=F, include = F}
librarian::shelf(ggplot2, dplyr, rqti)
library(rqti)
df <- c(15:100, 1015:1100)
es_d <- seq(0.2, 1.5, 0.1)

grid <- expand.grid(df=df, es_d=es_d, alpha = seq(0.01, 0.1, 0.01))
grid <- grid %>%
  mutate(es_t = round(es_d*sqrt(df)/2, 2),
         criterion = round(qt(1-alpha, df), 2),
         beta = round(pt(criterion - es_t, df), 2)) %>%
  filter(beta >= 0.01) %>%
  sample_n(1)

df <- grid$df
es_t <- grid$es_t
es_d <- grid$es_d
criterion <- grid$criterion
beta <- grid$beta
alpha <- grid$alpha
print(grid)

x <- seq(-10, 10, 0.001)
N <- df + 2 
density_null <- dt(x, df)
df_null <- data.frame(x = x, y = density_null, hypothesis = "null") 
density_alternative <- dt(x, df, ncp = es_t)
df_alternative <- data.frame(x = x, y = density_alternative, hypothesis = "alternative")

d <- rbind(df_null, df_alternative)
# to have better zoom for plots
d <- d[d$y >= 0.001, ]

# this should be improved
d$below_criterion <- ifelse(d$x < criterion, "Below_criterion", "Above_criterion")
d$region <- as.factor(paste0(d$hypothesis, d$below_criterion))
d$case <- ifelse(d$region %in% c("nullBelow_criterion", "alternativeAbove_criterion"), 0, 1)

p <- ggplot(d, aes(x, y, fill = region)) +
  geom_line() + 
  geom_vline(xintercept = criterion, linetype = "dotted") +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  theme_classic() + 
#  annotate(geom = "text", x=c(0, es_t), y = -0.01, label = c(0, es_t)) + 
  #theme(legend.position = "none") + 
  annotate(geom = "text", x = criterion*1, y = max(d$y)*1.07, label = "Kriterium") + 
  scale_x_continuous("t") + 
  scale_y_continuous("Dichte") +
  theme(legend.position = c(0.1, 0.9))

  # a bit tricky because there are 4 cases
  #scale_fill_manual(values=c("#d8b365", "#5ab4ac", "#d8b365", "#5ab4ac"))
```

```{r, echo=F}
study <- sample(c("in der Lesefähigkeit zwischen Jungen und Mädchen", "zwischen Verhaltenstherapie und psychodynamischer Therapie", "zwischen digitaler Lehre und Präsenzlehre"), 1)
```

Sie planen eine Studie, bei der sie den *Unterschied* `r study` untersuchen. Vorab möchten Sie eine Power-Analyse durchführen und bitten eine Kollegen um Hilfe. Ihr Kollege visualisiert ein mögliches Szenario und sendet Ihnen folgende Hinweise:

```{r, echo =F}
p1 <- p  + 
  geom_ribbon(aes(ymin=0, ymax=y*case), alpha = 0.9) + 
#  annotate(geom = "text", x=criterion*c(0.8, 1.2), y = 0.01, label = c(beta, alpha)) +
  scale_fill_manual("Anteil Fläche", breaks = c("alternativeBelow_criterion", "nullAbove_criterion"),
                    values=c("#d8b365", "#5ab4ac", "#d8b365", "#5ab4ac"),
  labels = as.character(c(beta, alpha)))

p2 <- p + 
  geom_ribbon(aes(ymin=0, ymax=y*!case), alpha = 0.7) + 
#  annotate(geom = "text", x=criterion*c(0.8, 1.2), y = 0.01, label = c(1-alpha, 1-beta)) + 
  scale_fill_manual(name = "Anteil Fläche", breaks = c("alternativeAbove_criterion", "nullBelow_criterion"),
                    values=c("#d8b365", "#5ab4ac", "#d8b365", "#5ab4ac"),
  labels = c(as.character(c(1-beta, 1-alpha))))

sample(list(p1, p2), 1)[[1]]
```

Dargestellt sind zwei t-Verteilungen für die Freiheitsgrade von `r df`. Die Nullhypothese geht von einem Unterschied von 0 aus, somit auch einem t-Wert von 0. Die Alternativhypothese wurde nach Berücksichtigung eines realistisch zu erwartenden Effekts um einen t-Wert von `r es_t` konstruiert. Die mit Farbe gefüllten Flächen sind mit den entsprechenden Wahrscheinlichkeiten dargestellt. Die zwei Untersuchungs-Gruppen sind gleich groß.

Sie sind sich nicht ganz sicher, ob Ihr Kollege eine sinnvolle Power-Analyse berechnet hat und stellen sich nun die folgenden Fragen für dieses Szenario:

* Wie groß wurde Alpha gewählt? `r gap_numeric(alpha, response_identifier = "alpha")`
* Wie groß ist die Wahrscheinlichkeit die Nullhypothese anzunehmen, wenn Sie stimmt? `r gap_numeric(1-alpha, response_identifier = "one_minus_alpha")`
* Wie groß ist Beta? `r gap_numeric(beta, response_identifier = "beta")` 
* Wie groß ist die Power `r gap_numeric(1-beta, response_identifier = "power")` 
* Wie groß ist die angenommene Effektgröße d in der Population? Hinweis: Runden Sie auf zwei Dezimalstellen! `r gap_numeric(round(2*es_t/(sqrt(df)), 2), response_identifier = "d")`
* Wie groß ist die Gesamt-Stichprobe? `r gap_numeric(N, response_identifier = "NN")`

```{r echo=F, eval=F}
librarian::shelf(easystats)
t_to_d(es_t, df, alternative = "greater")$d
es_t
N
```

# feedback

1. Alpha ist die Fläche über dem Kriterium der Nullhypothesen-Verteilung (über der linken Verteilung).

2. 1-Alpha ist die Fläche unter dem Kriterium der Nullhypothesen-Verteilung (unter der linken Verteilung).

3. Beta ist die Fläche unter dem Kriterium der Alternativhypothesen-Verteilung (unter der rechten Verteilung).

4. Dei Power ist die Fläche über dem Kriterium der Alternativhypothesen-Verteilung (über der rechten Verteilung).

5. Bei gleich großen Stichproben gilt approximativ: $d = \frac{2t}{\sqrt{\mathrm{df}}} = \frac{2\cdot`r es_t`}{\sqrt{`r df`}} = `r es_d`$

6. Pro Mittelwert reduzieren sich die Freiheitsgrade um 1. Da es hier zwei Gruppen gibt gilt also $N=\mathrm{df}+2$
